<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

    <title>多图表查看</title>
    <script src="https://assets.pyecharts.org/assets/echarts.min.js" type="text/javascript"></script>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet">
    <style>
        .autocomplete-suggestions {
            border: 1px solid #999;
            background: #FFF;
            overflow: auto;
        }

        .autocomplete-suggestion {
            padding: 2px 5px;
            white-space: nowrap;
            overflow: hidden;
        }

        .autocomplete-selected {
            background: #F0F0F0;
        }

        .autocomplete-suggestions strong {
            font-weight: normal;
            color: #3399FF;
        }

        .autocomplete-group {
            padding: 2px 5px;
        }

        .autocomplete-group strong {
            display: block;
            border-bottom: 1px solid #000;
        }
    </style>
</head>
<body class="container-fluid">
<div>
    <div style="width: 80%; float: left;">
        {% include 'base_nav.html' with nav='dtb' %}
    </div>
    <div style="width: 20%; float: left; padding-top: 8px;" class="navbar navbar-default">
        <div class="btn-group" role="group">
            <button type="button" class="btn active btn-default more_show_type" value="default">默认</button>
            <button type="button" class="btn btn-default more_show_type" value="position">持仓</button>
            <button type="button" class="btn btn-default more_show_type" value="currency">数字货币</button>
        </div>
    </div>
    <div style="clear: both;"></div>
</div>
<div class="row">
    <div class="col-md-12">
        <div style="width: 100%;height: 100%;">
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_1" id="chart_input_1" value=""/>
                    <button id="chart_button_1" class="update btn btn-default btn-xs" data-num="1">Update</button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="120m">120M
                    </button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="d">d</button>
                    <button class="update_frequency_1 btn btn-default btn-xs" data-num="1" data-frequency="w">w</button>
                </div>
                <div id="chart_1" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_2" id="chart_input_2" value=""/>
                    <button id="chart_button_2" class="update btn btn-default btn-xs" data-num="2">Update</button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="120m">120m
                    </button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="d">d</button>
                    <button class="update_frequency_2 btn btn-default btn-xs" data-num="2" data-frequency="w">w</button>
                </div>
                <div id="chart_2" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_3" id="chart_input_3" value=""/>
                    <button id="chart_button_3" class="update btn btn-default btn-xs" data-num="3">Update</button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="120m">120m
                    </button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="d">d</button>
                    <button class="update_frequency_3 btn btn-default btn-xs" data-num="3" data-frequency="w">w</button>
                </div>
                <div id="chart_3" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_4" id="chart_input_4" value=""/>
                    <button id="chart_button_4" class="update btn btn-default btn-xs" data-num="4">Update</button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="120m">120m
                    </button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="d">d</button>
                    <button class="update_frequency_4 btn btn-default btn-xs" data-num="4" data-frequency="w">w</button>
                </div>
                <div id="chart_4" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_5" id="chart_input_5" value=""/>
                    <button id="chart_button_5" class="update btn btn-default btn-xs" data-num="5">Update</button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="120m">120m
                    </button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="d">d</button>
                    <button class="update_frequency_5 btn btn-default btn-xs" data-num="5" data-frequency="w">w</button>
                </div>
                <div id="chart_5" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
            <div style="width: 33%;height: 50%;float: left;border: 1px dashed #000;">
                <div>
                    <input class="autocomplete_stock" name="chart_input_6" id="chart_input_6" value=""/>
                    <button id="chart_button_6" class="update btn btn-default btn-xs" data-num="6">Update</button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="1m">1M
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="5m">5M
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="15m">15M
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="30m">30M
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="60m">60M
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="120m">120m
                    </button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="d">d</button>
                    <button class="update_frequency_6 btn btn-default btn-xs" data-num="6" data-frequency="w">w</button>
                </div>
                <div id="chart_6" style="width:100%; height:370px;margin-top: 10px;"></div>
            </div>
        </div>
        <div id="loading" style="width: 200px; height: 50px; position: fixed; right: 0; bottom: 0;"></div>
    </div>
</div>


<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.quicksearch/2.4.0/jquery.quicksearch.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery-easy-loading/2.0.0-rc.2/jquery.loading.min.js"></script>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery.devbridge-autocomplete/1.4.9/jquery.autocomplete.js"></script>
<script>

    $(
        function () {

            // 股票搜索
            $('.autocomplete_stock').autocomplete({
                minChars: 2,
                serviceUrl: "/charts/search/",
                params: {'tp': 'more'},
                dataType: 'json',
                deferRequestBy: 500,
                onSelect: function (suggestion) {
                    $(this).val(suggestion.data);
                }
            });

            var intervalId;

            var chart_1 = echarts.init(document.getElementById('chart_1'), 'white', {renderer: 'canvas'});
            var chart_2 = echarts.init(document.getElementById('chart_2'), 'white', {renderer: 'canvas'});
            var chart_3 = echarts.init(document.getElementById('chart_3'), 'white', {renderer: 'canvas'});
            var chart_4 = echarts.init(document.getElementById('chart_4'), 'white', {renderer: 'canvas'});
            var chart_5 = echarts.init(document.getElementById('chart_5'), 'white', {renderer: 'canvas'});
            var chart_6 = echarts.init(document.getElementById('chart_6'), 'white', {renderer: 'canvas'});
            var charts = {
                '1': chart_1,
                '2': chart_2,
                '3': chart_3,
                '4': chart_4,
                '5': chart_5,
                '6': chart_6,
            }
            var scheme_type = 'default';
            var codes = []

            $('.more_show_type').click(function () {
                $('.more_show_type').removeClass('active');
                $(this).addClass('active');
                scheme_type = $(this).val();
                init_scheme();
                update_charts(true);
            });

            function init_scheme() {
                // 从 cookie 中读取上次多值
                let show_codes = $.cookie(scheme_type);
                if (show_codes === undefined) {
                    show_codes = '1:SH.000001:5m|2:SH.000001:1m|3:BTC-USDT:5m|4:HK.00700:5m|5:SH.600900:5m|6:SH.600900:1m'
                }
                show_codes = show_codes.split('|')
                codes = []
                for (let i = 1; i <= 6; i++) {
                    let c = show_codes[i - 1];
                    c = c.split(':');
                    $('#chart_input_' + c[0]).val(c[1] + ':' + c[2]);
                    $('.update_frequency_' + c[0]).removeClass('btn-primary');
                    $('.update_frequency_' + c[0] + '[data-frequency=' + c[2] + ']').addClass('btn-primary');
                    codes.push({
                        'num': c[0],
                        'chart': charts[c[0]],
                        'code': c[1],
                        'frequency': c[2],
                    });
                }
            }

            init_scheme();

            function update_charts(update = false) {
                for (let i in codes) {
                    let c = codes[i]
                    fetchData_kline(c['chart'], c['code'], c['frequency'], update);
                }
            }

            update_charts()
            setInterval(update_charts, 30000);

            $('.update').click(function () {
                var num = $(this).attr('data-num')
                num = parseInt(num)
                var val = $('#chart_input_' + num).val()
                val = val.split(':')
                codes[num - 1]['code'] = val[0]
                codes[num - 1]['frequency'] = val[1]
                fetchData_kline(codes[num - 1]['chart'], codes[num - 1]['code'], codes[num - 1]['frequency'], true)
                var cookie = ''
                for (var i in codes) {
                    let c = codes[i]
                    cookie += c['num'] + ':' + c['code'] + ':' + c['frequency'] + '|'
                }
                $.cookie(scheme_type, cookie.substr(0, cookie.length - 1))
            });
            for (var u_f_i = 1; u_f_i <= 6; u_f_i++) {
                update_class = '.update_frequency_' + u_f_i;
                $(update_class).click(function () {
                    var num = $(this).attr('data-num');
                    var chart_input_id = '#chart_input_' + num;
                    var frequency = $(this).attr('data-frequency');
                    var val = $(chart_input_id).val()
                    val = val.split(':')
                    codes[num - 1]['code'] = val[0]
                    codes[num - 1]['frequency'] = frequency
                    var new_val = val[0] + ':' + frequency;
                    $(chart_input_id).val(new_val);
                    $('.update_frequency_' + num).removeClass('btn-primary');
                    $(this).addClass('btn-primary');
                    fetchData_kline(codes[num - 1]['chart'], codes[num - 1]['code'], codes[num - 1]['frequency'], true)
                    var cookie = ''
                    for (var i in codes) {
                        let c = codes[i]
                        cookie += c['num'] + ':' + c['code'] + ':' + c['frequency'] + '|'
                    }
                    $.cookie(scheme_type, cookie.substr(0, cookie.length - 1))
                });
            }


            function fetchData_kline(chart, code, frequency, update = false) {
                $('#loading').loading({theme: 'dark'});
                $.ajax({
                    type: "GET",
                    url: "/charts/more/kline?code=" + code + '&frequency=' + frequency,
                    {#dataType: 'json',#}
                    success: function (result) {
                        var re_obj = (new Function("return " + result))();
                        if (update) {
                            chart.clear();
                        }
                        chart.setOption(re_obj);
                        $('#loading').loading('stop');
                    }
                });
            }
        }
    );


</script>
</body>
</html>
